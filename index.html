<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ Meow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f8f9fa">
    <link rel="apple-touch-icon" href="icon192x192.png">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; height: 100vh; display: flex; flex-direction: column; }
        .top-bar { background: #fff; padding: 15px 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .date-display { font-weight: bold; font-size: 1.1rem; color: #333; }
        .main-content { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 20px; }
        .amount-input { font-size: 3rem; text-align: center; border: none; background: transparent; width: 100%; font-weight: bold; color: #d63384; outline: none; }
        .note-input { margin-top: 20px; text-align: center; border: 1px solid #ddd; border-radius: 10px; padding: 10px; width: 100%; }
        .save-btn { margin-top: 30px; width: 100%; padding: 15px; border-radius: 50px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 15px rgba(214, 51, 132, 0.4); background: linear-gradient(45deg, #d63384, #fd7e14); border: none; color: white; }
        .save-btn:active { transform: scale(0.98); }
        .footer { text-align: center; font-size: 0.8rem; color: #aaa; padding: 10px; }
        
        /* List Styles */
        .modal-body { max-height: 60vh; overflow-y: auto; background-color: #fff; }
        .expense-item { background: white; border-bottom: 1px solid #f0f0f0; padding: 12px 5px; display: flex; justify-content: space-between; align-items: center; }
        .expense-time { font-size: 0.75rem; color: #888; }
        
        /* Status Dots */
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 3px rgba(0,0,0,0.2); }
        .status-synced { background-color: #198754; border: 2px solid #fff; } 
        .status-pending { background-color: #dc3545; border: 2px solid #fff; animation: pulse 2s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Alert Container */
        #alert-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; max-width: 400px; }
        .custom-alert { box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: none; border-radius: 15px; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Loading */
        .loading-spinner { display: flex; justify-content: center; align-items: center; padding: 20px; color: #d63384; }
    </style>
</head>
<body>

    <div id="alert-container"></div>

    <div class="top-bar sticky-top">
        <button class="btn btn-outline-secondary btn-sm" onclick="showHistoryFromCloud()">
            <i class="bi bi-cloud-download"></i> Cloud
        </button>
        <div class="date-display" id="currentDate">--/--/----</div>
        <button class="btn btn-outline-primary btn-sm" onclick="showTodayList()">
            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        </button>
    </div>

    <div class="main-content">
        <div class="text-center mb-2 text-muted">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
        <input type="number" id="amount" class="amount-input" placeholder="0" inputmode="decimal">
        <input type="text" id="note" class="note-input" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
        <button class="save-btn" onclick="saveExpense()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üêæ</button>
    </div>

    <div class="footer">
        Version 4.0 Cloud Manager by Cat üê±<br>
        <span id="connectionStatus" style="font-size: 0.7rem;">Checking...</span>
    </div>

    <div class="modal fade" id="listModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalListBody"></div>
                
                <div class="modal-footer d-flex flex-column">
                    <div class="d-flex justify-content-between w-100 mb-2">
                        <span class="text-muted">‡∏£‡∏ß‡∏°:</span>
                        <strong id="modalTotal" class="text-danger fs-5">0</strong>
                    </div>
                    <hr class="w-100 my-1">
                    <button type="button" id="clearCacheBtn" class="btn btn-outline-danger btn-sm w-100 mt-2" onclick="clearAllCache()">
                        <i class="bi bi-trash3-fill"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Reset)
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm w-100 mt-2" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Cloud)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editRow">
                    <div class="mb-3">
                        <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                        <input type="number" id="editAmount" class="form-control form-control-lg text-center fw-bold text-primary" inputmode="decimal">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <input type="text" id="editNote" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="button" class="btn btn-primary" onclick="submitEdit()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- SETUP ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzihzLVOFEqn_ydRhoUMZaNpBrSpfKEREx10d65klULXTBGHhXH29tNRzmdjwxKvThW_g/exec'; 

        // --- ALERT SYSTEM ---
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            let icon = type === 'success' ? '<i class="bi bi-check-circle-fill me-2"></i>' : '<i class="bi bi-exclamation-triangle-fill me-2"></i>';
            let colorClass = type === 'success' ? 'alert-success' : 'alert-warning';
            const html = `<div id="${alertId}" class="alert ${colorClass} custom-alert d-flex align-items-center alert-dismissible fade show" role="alert">${icon}<div>${message}</div><button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
            container.innerHTML = html;
            setTimeout(() => { const alertEl = document.getElementById(alertId); if (alertEl) { const bsAlert = new bootstrap.Alert(alertEl); bsAlert.close(); } }, 3000);
        }

        // --- DATA MANAGEMENT ---
        function getExpenses() {
            const data = localStorage.getItem('expenses_db');
            return data ? JSON.parse(data) : [];
        }

        function saveToLocal(expenses) {
            localStorage.setItem('expenses_db', JSON.stringify(expenses));
        }

        function deleteItem(id) {
            if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°? (‡∏•‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)')) {
                let expenses = getExpenses();
                expenses = expenses.filter(e => e.id !== id); 
                saveToLocal(expenses);
                showTodayList(); 
                showAlert('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'warning');
            }
        }

        function clearAllCache() {
            const password = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:");
            if (password === '123456789') {
                if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏¢‡∏ô‡∏∞?')) {
                    localStorage.removeItem('expenses_db');
                    location.reload(); 
                }
            } else if (password !== null) {
                alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! üòæ');
            }
        }

        // --- CLOUD MANAGEMENT (NEW) ---
        async function deleteCloudItem(row) {
            const password = prompt("‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô Cloud:");
            if (password === '123456789') {
                // ‡∏õ‡∏¥‡∏î Modal ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á Loading
                const listModal = bootstrap.Modal.getInstance(document.getElementById('listModal'));
                listModal.hide();
                showAlert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô Cloud...', 'warning');

                try {
                    const formData = new FormData();
                    formData.append('action', 'delete');
                    formData.append('row', row);

                    await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: formData });
                    
                    setTimeout(() => {
                        showAlert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô Cloud ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success');
                        showHistoryFromCloud(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
                    }, 2000); // ‡∏£‡∏≠‡πÅ‡∏õ‡πä‡∏ö‡πÄ‡∏û‡∏£‡∏≤‡∏∞ no-cors ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°
                } catch (e) {
                    alert('Error: ' + e);
                }
            } else if (password !== null) {
                alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏ö‡∏°‡∏±‡πà‡∏ß‡∏ã‡∏±‡πà‡∏ß‡∏ô‡∏∞! üòæ');
            }
        }

        // ‡πÄ‡∏õ‡∏¥‡∏î Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));
        function openEditModal(row, amount, note) {
            document.getElementById('editRow').value = row;
            document.getElementById('editAmount').value = amount;
            document.getElementById('editNote').value = note;
            
            // ‡∏ã‡πà‡∏≠‡∏ô Modal ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô
            const listModal = bootstrap.Modal.getInstance(document.getElementById('listModal'));
            listModal.hide();
            
            editModal.show();
        }

        async function submitEdit() {
            const row = document.getElementById('editRow').value;
            const amount = document.getElementById('editAmount').value;
            const note = document.getElementById('editNote').value;

            if(!amount) return alert('‡πÉ‡∏™‡πà‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö');

            editModal.hide();
            showAlert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç...', 'warning');

            const formData = new FormData();
            formData.append('action', 'edit');
            formData.append('row', row);
            formData.append('amount', amount);
            formData.append('note', note);

            await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: formData });

            setTimeout(() => {
                showAlert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success');
                showHistoryFromCloud(); // ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Cloud ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
            }, 2000);
        }


        // --- UI LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const options = { year: 'numeric', month: 'short', day: 'numeric', weekday: 'short' };
            document.getElementById('currentDate').innerText = now.toLocaleDateString('th-TH', options);
            
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            syncPendingData();
        });

        function updateOnlineStatus() {
            const status = document.getElementById('connectionStatus');
            if (navigator.onLine) {
                status.innerText = "Online (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô)";
                status.style.color = "green";
                syncPendingData();
            } else {
                status.innerText = "Offline (‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå)";
                status.style.color = "red";
            }
        }

        async function saveExpense() {
            const amount = document.getElementById('amount').value;
            const note = document.getElementById('note').value;

            if (!amount || amount <= 0) {
                showAlert('‡πÉ‡∏™‡πà‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏à‡πâ‡∏≤‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå üòΩ', 'warning');
                return;
            }

            const now = new Date();
            const expense = {
                id: Date.now(),
                date: now.toLocaleDateString('th-TH'), 
                rawDate: now.toISOString().split('T')[0], 
                time: now.toLocaleTimeString('th-TH'),
                amount: parseFloat(amount),
                note: note,
                synced: false
            };

            const expenses = getExpenses();
            expenses.push(expense);
            saveToLocal(expenses);

            document.getElementById('amount').value = '';
            document.getElementById('note').value = '';
            document.getElementById('amount').focus();
            showAlert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! üò∏', 'success');

            if (navigator.onLine) {
                const success = await sendToGoogleSheet(expense);
                if (success) {
                    const updatedExpenses = getExpenses();
                    const target = updatedExpenses.find(e => e.id === expense.id);
                    if (target) target.synced = true;
                    saveToLocal(updatedExpenses);
                }
            }
        }

        async function sendToGoogleSheet(data) {
            try {
                const formData = new FormData();
                formData.append('action', 'add'); // ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Action Add
                formData.append('date', data.date);
                formData.append('time', data.time);
                formData.append('amount', data.amount);
                formData.append('note', data.note || '');

                await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: formData });
                return true; 
            } catch (error) {
                console.error("Error:", error);
                return false;
            }
        }

        async function syncPendingData() {
            const expenses = getExpenses();
            const pending = expenses.filter(e => !e.synced);
            if (pending.length > 0 && navigator.onLine) {
                for (let item of pending) {
                    const success = await sendToGoogleSheet(item);
                    if (success) item.synced = true;
                }
                saveToLocal(expenses);
            }
        }

        // --- DISPLAY LOGIC ---
        const modal = new bootstrap.Modal(document.getElementById('listModal'));

        function showTodayList() {
            const nowStr = new Date().toISOString().split('T')[0];
            const expenses = getExpenses();
            const todayItems = expenses.filter(e => e.rawDate === nowStr);
            renderList("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)", todayItems, false);
            document.getElementById('clearCacheBtn').style.display = 'block'; // ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á
            modal.show();
        }

        function showHistoryFromCloud() {
            if (!navigator.onLine) {
                showAlert('‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡πá‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π Cloud ‡∏ô‡∏∞‡πÄ‡∏´‡∏°‡∏µ‡∏¢‡∏ß üòø', 'warning');
                return;
            }

            document.getElementById('modalTitle').innerText = "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Google Sheet";
            document.getElementById('modalListBody').innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status"></div>
                    <span class="ms-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
                </div>`;
            document.getElementById('modalTotal').innerText = "...";
            document.getElementById('clearCacheBtn').style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á Cache ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏î‡∏π Cloud
            
            modal.show();

            fetch(GOOGLE_SCRIPT_URL)
                .then(response => response.json())
                .then(data => { processCloudData(data); })
                .catch(error => {
                    document.getElementById('modalListBody').innerHTML = `<div class="text-center text-danger p-3">Error: ${error}</div>`;
                });
        }

        function processCloudData(data) {
            const dailyMap = {};
            let totalAll = 0;
            data.forEach(item => {
                const amount = parseFloat(item.amount);
                totalAll += amount;
                if (!dailyMap[item.date]) dailyMap[item.date] = [];
                dailyMap[item.date].push(item);
            });

            let html = '';
            const dates = Object.keys(dailyMap).reverse();
            
            if (dates.length === 0) html = '<div class="text-center py-3 text-muted">Empty</div>';
            else {
                html += '<div class="accordion" id="historyAccordion">';
                dates.forEach((date, index) => {
                    const items = dailyMap[date];
                    let dayTotal = items.reduce((sum, item) => sum + parseFloat(item.amount), 0);
                    let collapseId = `collapse${index}`;
                    html += `
                    <div class="accordion-item border-0 mb-2 shadow-sm rounded overflow-hidden">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed d-flex justify-content-between" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                <div class="w-100 d-flex justify-content-between pe-2">
                                    <span>${date}</span>
                                    <span class="fw-bold text-primary">${dayTotal.toLocaleString()}</span>
                                </div>
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#historyAccordion">
                            <div class="accordion-body bg-light p-2">
                                ${items.map(item => `
                                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom border-white">
                                        <div class="flex-grow-1">
                                            <div class="fw-bold">${parseFloat(item.amount).toLocaleString()}</div>
                                            <small class="text-muted">${item.time} ${item.note ? '('+item.note+')' : ''}</small>
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="openEditModal(${item.row}, ${item.amount}, '${item.note||''}')"><i class="bi bi-pencil"></i></button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCloudItem(${item.row})"><i class="bi bi-trash"></i></button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>`;
                });
                html += '</div>';
            }
            document.getElementById('modalListBody').innerHTML = html;
            document.getElementById('modalTotal').innerText = totalAll.toLocaleString() + " ‡∏ö‡∏≤‡∏ó";
        }

        function renderList(title, items) {
            let html = '';
            let total = 0;
            items.sort((a, b) => b.id - a.id);

            items.forEach(item => {
                total += item.amount;
                const statusClass = item.synced ? 'status-synced' : 'status-pending';
                const statusTitle = item.synced ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
                const noteTxt = item.note ? `<div class="small text-muted">${item.note}</div>` : '';
                
                html += `
                <div class="expense-item">
                    <div class="d-flex align-items-center flex-grow-1">
                        <span class="status-dot ${statusClass}" title="${statusTitle}"></span>
                        <div class="ms-2">
                            <div class="fw-bold fs-5">${item.amount.toLocaleString()} ‡∏ø</div>
                            <div class="expense-time">${item.time} ${noteTxt}</div>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger border-0" onclick="deleteItem(${item.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>`;
            });

            if (items.length === 0) html = '<div class="text-center py-5 text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>';

            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalListBody').innerHTML = html;
            document.getElementById('modalTotal').innerText = total.toLocaleString() + " ‡∏ö‡∏≤‡∏ó";
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>