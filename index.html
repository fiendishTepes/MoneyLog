<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ Meow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f8f9fa">
    <link rel="apple-touch-icon" href="icon192x192.png">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; height: 100vh; display: flex; flex-direction: column; }
        .top-bar { background: #fff; padding: 15px 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .date-display { font-weight: bold; font-size: 1.1rem; color: #333; }
        .main-content { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 20px; }
        .amount-input { font-size: 3rem; text-align: center; border: none; background: transparent; width: 100%; font-weight: bold; color: #d63384; outline: none; }
        .note-input { margin-top: 20px; text-align: center; border: 1px solid #ddd; border-radius: 10px; padding: 10px; width: 100%; }
        .save-btn { margin-top: 30px; width: 100%; padding: 15px; border-radius: 50px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 15px rgba(214, 51, 132, 0.4); background: linear-gradient(45deg, #d63384, #fd7e14); border: none; color: white; }
        .save-btn:active { transform: scale(0.98); }
        .footer { text-align: center; font-size: 0.8rem; color: #aaa; padding: 10px; }
        
        /* Modal Styles */
        .modal-body { max-height: 60vh; overflow-y: auto; }
        .expense-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .expense-time { font-size: 0.8rem; color: #888; }
        .sync-status { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .synced { background-color: #198754; } 
        .not-synced { background-color: #ffc107; }

        /* Alert Container Style (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà) */
        #alert-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            width: 90%;
            max-width: 400px;
        }
        .custom-alert {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: none;
            border-radius: 15px;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="alert-container"></div>

    <div class="top-bar sticky-top">
        <button class="btn btn-outline-secondary btn-sm" onclick="showHistory()">
            <i class="bi bi-clock-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        </button>
        <div class="date-display" id="currentDate">--/--/----</div>
        <button class="btn btn-outline-primary btn-sm" onclick="showTodayList()">
            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        </button>
    </div>

    <div class="main-content">
        <div class="text-center mb-2 text-muted">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
        <input type="number" id="amount" class="amount-input" placeholder="0" inputmode="decimal">
        <input type="text" id="note" class="note-input" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
        <button class="save-btn" onclick="saveExpense()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ üêæ</button>
    </div>

    <div class="footer">
        Version 1.3 UI Alert by Cat üê±<br>
        <span id="connectionStatus" style="font-size: 0.7rem;">Checking...</span>
    </div>

    <div class="modal fade" id="listModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalListBody"></div>
                <div class="modal-footer justify-content-between">
                    <span class="text-muted small">‡∏£‡∏ß‡∏°: <strong id="modalTotal" class="text-danger">0</strong> ‡∏ö‡∏≤‡∏ó</span>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- SETUP ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzTZZrf2qT5DZDuZHOIhJROQhOUxFyyUwkhyE865a4skEVhdEQhU1tSgF3E2umH1FdDaQ/exec'; 
        
        // --- ALERT SYSTEM (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà) ---
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            
            // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            let icon = type === 'success' ? '<i class="bi bi-check-circle-fill me-2"></i>' : '<i class="bi bi-exclamation-triangle-fill me-2"></i>';
            let colorClass = type === 'success' ? 'alert-success' : 'alert-warning';

            const html = `
                <div id="${alertId}" class="alert ${colorClass} custom-alert d-flex align-items-center alert-dismissible fade show" role="alert">
                    ${icon}
                    <div>${message}</div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            container.innerHTML = html; // ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ó‡∏ô‡∏≠‡∏±‡∏ô‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏•‡∏¢ (‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞)

            // ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡πÄ‡∏≠‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setTimeout(() => {
                const alertEl = document.getElementById(alertId);
                if (alertEl) {
                    const bsAlert = new bootstrap.Alert(alertEl);
                    bsAlert.close();
                }
            }, 3000);
        }

        // --- DATA MANAGEMENT ---
        function getExpenses() {
            const data = localStorage.getItem('expenses_db');
            return data ? JSON.parse(data) : [];
        }

        function saveToLocal(expenses) {
            localStorage.setItem('expenses_db', JSON.stringify(expenses));
        }

        // --- UI LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const options = { year: 'numeric', month: 'short', day: 'numeric', weekday: 'short' };
            document.getElementById('currentDate').innerText = now.toLocaleDateString('th-TH', options);
            
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            syncPendingData();
        });

        function updateOnlineStatus() {
            const status = document.getElementById('connectionStatus');
            if (navigator.onLine) {
                status.innerText = "Online (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Sheet)";
                status.style.color = "green";
                syncPendingData();
            } else {
                status.innerText = "Offline (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô)";
                status.style.color = "orange";
            }
        }

        async function saveExpense() {
            const amount = document.getElementById('amount').value;
            const note = document.getElementById('note').value;

            if (!amount || amount <= 0) {
                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô alert ‡πÄ‡∏õ‡πá‡∏ô showAlert
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡πÄ‡∏´‡∏°‡∏µ‡∏¢‡∏ß üòΩ', 'warning');
                return;
            }

            const now = new Date();
            const expense = {
                id: Date.now(),
                date: now.toLocaleDateString('th-TH'), 
                rawDate: now.toISOString().split('T')[0], 
                time: now.toLocaleTimeString('th-TH'),
                amount: parseFloat(amount),
                note: note,
                synced: false
            };

            const expenses = getExpenses();
            expenses.push(expense);
            saveToLocal(expenses);

            document.getElementById('amount').value = '';
            document.getElementById('note').value = '';
            document.getElementById('amount').focus(); // ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å
            
            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            showAlert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏à‡πâ‡∏≤! üò∏', 'success');

            if (navigator.onLine) {
                const success = await sendToGoogleSheet(expense);
                if (success) {
                    const updatedExpenses = getExpenses();
                    const target = updatedExpenses.find(e => e.id === expense.id);
                    if (target) target.synced = true;
                    saveToLocal(updatedExpenses);
                }
            }
        }

        // --- SYNC ENGINE ---
        async function sendToGoogleSheet(data) {
            try {
                const formData = new FormData();
                formData.append('date', data.date);
                formData.append('time', data.time);
                formData.append('amount', data.amount);
                formData.append('note', data.note || '');

                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: formData
                });
                return true; 
            } catch (error) {
                console.error("Error:", error);
                return false;
            }
        }

        async function syncPendingData() {
            const expenses = getExpenses();
            const pending = expenses.filter(e => !e.synced);
            
            if (pending.length > 0 && navigator.onLine) {
                for (let item of pending) {
                    const success = await sendToGoogleSheet(item);
                    if (success) item.synced = true;
                }
                saveToLocal(expenses);
            }
        }

        // --- REPORT UI ---
        const modal = new bootstrap.Modal(document.getElementById('listModal'));

        function showTodayList() {
            const nowStr = new Date().toISOString().split('T')[0];
            const expenses = getExpenses();
            const todayItems = expenses.filter(e => e.rawDate === nowStr);
            renderList("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", todayItems);
        }

        function showHistory() {
            const expenses = getExpenses();
            const dailyMap = {};
            expenses.forEach(e => {
                if (!dailyMap[e.date]) dailyMap[e.date] = 0;
                dailyMap[e.date] += e.amount;
            });

            let html = '<ul class="list-group">';
            let totalAll = 0;
            Object.keys(dailyMap).reverse().forEach(date => {
                totalAll += dailyMap[date];
                html += `
                <li class="list-group-item d-flex justify-content-between align-items-center" onclick="showDetailByDate('${date}')" style="cursor:pointer;">
                    ${date}
                    <span class="badge bg-primary rounded-pill">${dailyMap[date].toLocaleString()} ‡∏ø</span>
                </li>`;
            });
            html += '</ul>';

            document.getElementById('modalTitle').innerText = "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô";
            document.getElementById('modalListBody').innerHTML = html;
            document.getElementById('modalTotal').innerText = totalAll.toLocaleString();
            modal.show();
        }

        function showDetailByDate(dateStr) {
            const expenses = getExpenses();
            const items = expenses.filter(e => e.date === dateStr);
            renderList(`‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${dateStr}`, items);
        }

        function renderList(title, items) {
            let html = '';
            let total = 0;
            items.sort((a, b) => b.id - a.id);

            items.forEach(item => {
                total += item.amount;
                const statusColor = item.synced ? 'synced' : 'not-synced';
                const noteTxt = item.note ? `<br><small class="text-muted">(${item.note})</small>` : '';
                
                html += `
                <div class="expense-item">
                    <div>
                        <div class="fw-bold">${item.amount.toLocaleString()} ‡∏ø</div>
                        <div class="expense-time">
                            <span class="sync-status ${statusColor}"></span>${item.time}
                        </div>
                    </div>
                    <div class="text-end">${noteTxt}</div>
                </div>`;
            });

            if (items.length === 0) html = '<div class="text-center py-3 text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡πâ‡∏≤</div>';

            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalListBody').innerHTML = html;
            document.getElementById('modalTotal').innerText = total.toLocaleString();
            modal.show();
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>