<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#f8f9fa">
    <link rel="apple-touch-icon" href="icon192x192.png">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Sarabun', sans-serif; height: 100vh; display: flex; flex-direction: column; }
        .top-bar { background: #fff; padding: 15px 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .date-display { font-weight: bold; font-size: 1.1rem; color: #333; }
        .main-content { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 20px; }
        .amount-input { font-size: 3rem; text-align: center; border: none; background: transparent; width: 100%; font-weight: bold; color: #d63384; outline: none; }
        .note-input { margin-top: 20px; text-align: center; border: 1px solid #ddd; border-radius: 10px; padding: 10px; width: 100%; }
        .save-btn { margin-top: 30px; width: 100%; padding: 15px; border-radius: 50px; font-size: 1.2rem; font-weight: bold; box-shadow: 0 4px 15px rgba(214, 51, 132, 0.4); background: linear-gradient(45deg, #d63384, #fd7e14); border: none; color: white; }
        .save-btn:active { transform: scale(0.98); }
        .footer { text-align: center; font-size: 0.8rem; color: #aaa; padding: 10px; }
        
        /* Modal Customization */
        .modal-body { max-height: 60vh; overflow-y: auto; }
        .expense-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .expense-time { font-size: 0.8rem; color: #888; }
        .sync-status { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .synced { background-color: #198754; }
        .not-synced { background-color: #ffc107; }
    </style>
</head>
<body>

    <div class="top-bar sticky-top">
        <button class="btn btn-outline-secondary btn-sm" onclick="showHistory()">
            <i class="bi bi-clock-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        </button>
        <div class="date-display" id="currentDate">--/--/----</div>
        <button class="btn btn-outline-primary btn-sm" onclick="showTodayList()">
            ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        </button>
    </div>

    <div class="main-content">
        <div class="text-center mb-2 text-muted">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</div>
        <input type="number" id="amount" class="amount-input" placeholder="0" inputmode="decimal">
        
        <input type="text" id="note" class="note-input" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
        
        <button class="save-btn" onclick="saveExpense()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
    </div>

    <div class="footer">
        Version 1.0 by Cat üê±<br>
        <span id="connectionStatus" style="font-size: 0.7rem;">Checking...</span>
    </div>

    <div class="modal fade" id="listModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalListBody">
                    </div>
                <div class="modal-footer justify-content-between">
                    <span class="text-muted small">‡∏£‡∏ß‡∏°: <strong id="modalTotal" class="text-danger">0</strong> ‡∏ö‡∏≤‡∏ó</span>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- SETUP ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwfsZsqFXvn8gMYNgUWhi2h9zb_Zabcmwxp43812bhO1xJlFj0I-PWoZ5apGIMCnLPB/exec'; 
        
        // --- DATA MANAGEMENT ---
        function getExpenses() {
            const data = localStorage.getItem('expenses_db');
            return data ? JSON.parse(data) : [];
        }

        function saveToLocal(expenses) {
            localStorage.setItem('expenses_db', JSON.stringify(expenses));
        }

        // --- UI LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const options = { year: 'numeric', month: 'short', day: 'numeric', weekday: 'short' };
            document.getElementById('currentDate').innerText = now.toLocaleDateString('th-TH', options);
            
            // Check internet status
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            
            // Try syncing pending data on load
            syncPendingData();
        });

        function updateOnlineStatus() {
            const status = document.getElementById('connectionStatus');
            if (navigator.onLine) {
                status.innerText = "Online (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Sheet)";
                status.style.color = "green";
                syncPendingData();
            } else {
                status.innerText = "Offline (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)";
                status.style.color = "orange";
            }
        }

        async function saveExpense() {
            const amount = document.getElementById('amount').value;
            const note = document.getElementById('note').value;

            if (!amount || amount <= 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö‡πÄ‡∏´‡∏°‡∏µ‡∏¢‡∏ß');
                return;
            }

            const now = new Date();
            const expense = {
                id: Date.now(),
                date: now.toLocaleDateString('th-TH'), // Format for sheet
                rawDate: now.toISOString().split('T')[0], // Format for filtering
                time: now.toLocaleTimeString('th-TH'),
                amount: parseFloat(amount),
                note: note,
                synced: false
            };

            // 1. Save Local First (Safety)
            const expenses = getExpenses();
            expenses.push(expense);
            saveToLocal(expenses);

            // Clear inputs
            document.getElementById('amount').value = '';
            document.getElementById('note').value = '';
            
            // 2. Try Syncing
            if (navigator.onLine) {
                const success = await sendToGoogleSheet(expense);
                if (success) {
                    // Update sync status in local storage
                    const updatedExpenses = getExpenses();
                    const target = updatedExpenses.find(e => e.id === expense.id);
                    if (target) target.synced = true;
                    saveToLocal(updatedExpenses);
                }
            }

            alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢! üê±');
        }

        // --- SYNC ENGINE ---
        async function sendToGoogleSheet(data) {
            try {
                // ‡πÉ‡∏ä‡πâ no-cors ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ browser block ‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ response ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á
                // ‡πÅ‡∏ï‡πà‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏µ‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ PWA ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                return true; 
            } catch (error) {
                console.error("Sync Error:", error);
                return false;
            }
        }

        async function syncPendingData() {
            const expenses = getExpenses();
            const pending = expenses.filter(e => !e.synced);
            
            if (pending.length > 0 && navigator.onLine) {
                console.log(`Found ${pending.length} pending items. Syncing...`);
                for (let item of pending) {
                    const success = await sendToGoogleSheet(item);
                    if (success) {
                        item.synced = true;
                    }
                }
                saveToLocal(expenses); // Update status back to local
            }
        }

        // --- REPORT UI ---
        const modal = new bootstrap.Modal(document.getElementById('listModal'));

        function showTodayList() {
            const nowStr = new Date().toISOString().split('T')[0];
            const expenses = getExpenses();
            const todayItems = expenses.filter(e => e.rawDate === nowStr);
            renderList("‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", todayItems);
        }

        function showHistory() {
            // ‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏¢‡∏∏‡∏ö‡∏£‡∏ß‡∏°)
            const expenses = getExpenses();
            const dailyMap = {};
            
            expenses.forEach(e => {
                if (!dailyMap[e.date]) dailyMap[e.date] = 0;
                dailyMap[e.date] += e.amount;
            });

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏ß‡∏±‡∏ô
            let html = '<ul class="list-group">';
            let totalAll = 0;
            
            // Sort by date desc (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô)
            Object.keys(dailyMap).reverse().forEach(date => {
                totalAll += dailyMap[date];
                html += `
                <li class="list-group-item d-flex justify-content-between align-items-center" onclick="showDetailByDate('${date}')" style="cursor:pointer;">
                    ${date}
                    <span class="badge bg-primary rounded-pill">${dailyMap[date].toLocaleString()} ‡∏ø</span>
                </li>`;
            });
            html += '</ul>';

            document.getElementById('modalTitle').innerText = "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)";
            document.getElementById('modalListBody').innerHTML = html;
            document.getElementById('modalTotal').innerText = totalAll.toLocaleString();
            modal.show();
        }

        function showDetailByDate(dateStr) {
            const expenses = getExpenses();
            const items = expenses.filter(e => e.date === dateStr);
            renderList(`‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${dateStr}`, items);
        }

        function renderList(title, items) {
            let html = '';
            let total = 0;
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î
            items.sort((a, b) => b.id - a.id);

            items.forEach(item => {
                total += item.amount;
                const statusColor = item.synced ? 'synced' : 'not-synced';
                const noteTxt = item.note ? `<br><small class="text-muted">(${item.note})</small>` : '';
                
                html += `
                <div class="expense-item">
                    <div>
                        <div class="fw-bold">${item.amount.toLocaleString()} ‡∏ø</div>
                        <div class="expense-time">
                            <span class="sync-status ${statusColor}" title="${item.synced ? 'Synced' : 'Pending'}"></span>
                            ${item.time}
                        </div>
                    </div>
                    <div class="text-end">
                        ${noteTxt}
                    </div>
                </div>`;
            });

            if (items.length === 0) html = '<div class="text-center py-3 text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡πâ‡∏≤</div>';

            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalListBody').innerHTML = html;
            document.getElementById('modalTotal').innerText = total.toLocaleString();
            
            // ‡∏ñ‡πâ‡∏≤ Modal ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å Today)
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å History) ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡πÅ‡∏Ñ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô content
            modal.show();
        }
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
            .then(() => console.log('Service Worker Registered'));
        }
    </script>
</body>
</html>